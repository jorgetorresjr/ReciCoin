<!DOCTYPE html>
<html lang="pt-br" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>Pontos de Coleta - ReciCoin</title>
    <link rel="stylesheet" th:href="@{/css/custom.css}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        .points-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 25px; margin-top: 30px; }
        .point-card { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; flex-direction: column; justify-content: space-between; }
        .point-header { display: flex; align-items: center; gap: 15px; margin-bottom: 15px; }
        .point-icon { width: 50px; height: 50px; background-color: #E8F5E9; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #2E7D32; font-size: 1.5rem; }
        
        /* Modal Styles */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; width: 90%; max-width: 400px; text-align: center; }
    </style>
</head>
<body>

    <nav style="background: white; padding: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center;">
        <h2 style="margin: 0; color: #2E7D32; cursor: pointer;" onclick="window.location.href='/'"><i class="fas fa-leaf"></i> ReciCoin</h2>
        <div id="navButtons">
            <a href="/login" class="btn btn-secondary">Entrar</a>
        </div>
    </nav>

    <div class="container" style="margin-top: 40px;">
        <div class="text-center">
            <h1>Encontre um Ponto de Coleta</h1>
            <p>Agende a entrega dos seus resíduos.</p>
        </div>
        <div id="pointsContainer" class="points-grid">
            <p class="text-center">Carregando...</p>
        </div>
    </div>

    <div id="scheduleModal" class="modal-overlay">
        <div class="modal-content">
            <h3>Agendar Coleta</h3>
            <p id="modalPointName" style="color: #666; margin-bottom: 20px;"></p>
            
            <form id="scheduleForm">
                <input type="hidden" id="selectedPointId">
                <input type="hidden" id="pointOpenTime">
                <input type="hidden" id="pointCloseTime">

                <div class="form-group">
                    <label class="form-label">Data e Hora</label>
                    <input type="datetime-local" id="appointmentDate" class="form-control" required>
                    <small id="timeWarning" style="color: red; display: none;">Horário inválido! O local funciona das <span id="lblOpen"></span> às <span id="lblClose"></span>.</small>
                </div>
                
                <div style="display: flex; gap: 10px; justify-content: center; margin-top: 20px;">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Confirmar</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const token = localStorage.getItem('token');

        // Configura Navbar
        if (token) {
            document.getElementById('navButtons').innerHTML = `<button onclick="logout()" class="btn btn-secondary" style="border-color: red; color: red;">Sair</button>`;
        }

        function logout() { localStorage.removeItem('token'); window.location.href = '/login'; }

        // Carrega Pontos
        document.addEventListener('DOMContentLoaded', async () => {
            const container = document.getElementById('pointsContainer');
            try {
                const response = await fetch('/collection-point/all');
                const points = await response.json();
                
                container.innerHTML = '';
                points.forEach(point => {
                    // Adiciona botão de agendar SOMENTE se estiver logado
                    const btnAgendar = token 
                        ? `<button onclick="openModal('${point.id}', '${point.name}', '${point.openingTime}', '${point.closingTime}')" class="btn btn-primary" style="width:100%; margin-top:15px;">Agendar Entrega</button>` 
                        : `<p style="font-size:0.8rem; color:red; text-align:center; margin-top:10px;">Faça login para agendar</p>`;

                    container.innerHTML += `
                        <div class="point-card">
                            <div>
                                <div class="point-header">
                                    <div class="point-icon"><i class="fas fa-recycle"></i></div>
                                    <h3>${point.name}</h3>
                                </div>
                                <p>"${point.description || 'Recebemos recicláveis.'}"</p>
                                <p><i class="far fa-clock"></i> ${point.openingTime} - ${point.closingTime}</p>
                                <p><i class="fas fa-map-marker-alt"></i> ${point.address}, ${point.city}</p>
                            </div>
                            ${btnAgendar}
                        </div>`;
                });
            } catch (e) { container.innerHTML = '<p>Erro ao carregar.</p>'; }
        });

        // Lógica do Modal
        function openModal(id, name, open, close) {
            document.getElementById('scheduleModal').style.display = 'flex';
            document.getElementById('modalPointName').innerText = name;
            document.getElementById('selectedPointId').value = id;
            document.getElementById('pointOpenTime').value = open; // Formato HH:mm:ss
            document.getElementById('pointCloseTime').value = close;
            
            document.getElementById('lblOpen').innerText = open.substring(0,5);
            document.getElementById('lblClose').innerText = close.substring(0,5);
        }

        function closeModal() {
            document.getElementById('scheduleModal').style.display = 'none';
            document.getElementById('timeWarning').style.display = 'none';
        }

        // Validação e Envio
        document.getElementById('scheduleForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const dateInput = document.getElementById('appointmentDate').value; // YYYY-MM-DDTHH:mm
            const timePart = dateInput.split('T')[1] + ":00"; // HH:mm:00
            
            const open = document.getElementById('pointOpenTime').value;
            const close = document.getElementById('pointCloseTime').value;

            // Validação simples de horário
            if (timePart < open || timePart > close) {
                document.getElementById('timeWarning').style.display = 'block';
                return;
            }

            const payload = {
                collectionPointId: document.getElementById('selectedPointId').value,
                dateTime: dateInput
            };

            try {
                const response = await fetch('/appointments/create', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    alert('Agendamento realizado com sucesso!');
                    closeModal();
                } else {
                    alert('Erro ao agendar.');
                }
            } catch (error) { alert('Erro de conexão'); }
        });
    </script>
</body>
</html>